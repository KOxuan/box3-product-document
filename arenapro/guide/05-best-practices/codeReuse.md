# åŒç«¯å¼€å‘(ä¸€)ï¼šå…±äº«ä»£ç  (Single Source of Truth)

åœ¨å¼€å‘æ¸¸æˆæ—¶ï¼Œå¾ˆå¤šé€»è¾‘éœ€è¦åœ¨**æœåŠ¡ç«¯**å’Œ**å®¢æˆ·ç«¯**åŒæ—¶ç”¨åˆ°ã€‚

**æ€è€ƒè¿™ä¸ªåœºæ™¯**ï¼š

- **æœåŠ¡ç«¯**éœ€è¦æ ¹æ®ç©å®¶çš„ç­‰çº§å’Œè£…å¤‡ï¼Œè®¡ç®—å‡ºä»–åº”è¯¥é€ æˆçš„å®é™…ä¼¤å®³ã€‚
- **å®¢æˆ·ç«¯**ä¸ºäº†æœ‰æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œéœ€è¦åœ¨ç©å®¶æ‚¬åœåœ¨æŠ€èƒ½æŒ‰é’®ä¸Šæ—¶ï¼Œæå‰æ˜¾ç¤ºä¸€ä¸ªä¼¤å®³é¢„è§ˆçš„ Tooltipã€‚

å¦‚æœè¿™ä¸¤å¤„çš„ä¼¤å®³è®¡ç®—é€»è¾‘ä½ å†™äº†ä¸¤éï¼Œä¸€æ—¦ä¼¤å®³å…¬å¼éœ€è¦è°ƒæ•´ï¼Œä½ å¾ˆå¯èƒ½ä¼šå¿˜è®°ä¿®æ”¹å…¶ä¸­ä¸€å¤„ï¼Œå¯¼è‡´å®¢æˆ·ç«¯é¢„è§ˆå’ŒæœåŠ¡å™¨å®é™…ç»“ç®—ä¸ä¸€è‡´çš„ Bugã€‚

è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦**ä»£ç å…±äº«**çš„åŸå› ã€‚ArenaPro æä¾›äº†ä¸€ä¸ªä¸“é—¨çš„ `shares/` æ–‡ä»¶å¤¹ï¼Œæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å…±äº«ä»£ç ï¼Ÿ

åœ¨å¾ˆå¤šæ¸¸æˆä¸­ï¼Œå®¢æˆ·ç«¯ï¼ˆç©å®¶çœ‹åˆ°çš„ç•Œé¢ã€æ“ä½œï¼‰å’ŒæœåŠ¡ç«¯ï¼ˆæ¸¸æˆé€»è¾‘ã€æ•°æ®å¤„ç†ï¼‰éƒ½éœ€è¦å¤„ç†ä¸€äº›ç›¸åŒçš„æ¦‚å¿µã€‚ä¾‹å¦‚ï¼š

- **æ¸¸æˆå…¬å¼**ï¼šä¼¤å®³è®¡ç®—ã€ç»éªŒå€¼æ›²çº¿ã€æ‰è½ç‡ç­‰ã€‚
- **æ•°æ®ç»“æ„å®šä¹‰**ï¼šèƒŒåŒ…ç‰©å“ã€ç©å®¶å±æ€§ã€æŠ€èƒ½æ•°æ®ç­‰ TypeScript `interface` æˆ– `type`ã€‚
- **å¸¸é‡**ï¼šä¾‹å¦‚ `const MAX_PLAYERS = 16;`ã€‚
- **çº¯å·¥å…·å‡½æ•°**ï¼šä¸ä¾èµ–ä»»ä½•ç«¯ç¯å¢ƒçš„é€šç”¨å‡½æ•°ï¼ˆå¦‚æ•°å­¦è®¡ç®—ã€å­—ç¬¦ä¸²å¤„ç†ï¼‰ã€‚

åœ¨ VS Code çš„æ–‡ä»¶æµè§ˆå™¨ä¸­ï¼Œåœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ï¼ˆä¸ `client` å’Œ `server` åŒçº§ï¼‰ä¸‹ï¼Œ**æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªåä¸º `shares` çš„æ–°æ–‡ä»¶å¤¹**ã€‚

è¿™ä¸ªç›®å½•å°±æ˜¯æˆ‘ä»¬æœªæ¥å­˜æ”¾æ‰€æœ‰å…±äº«ä»£ç çš„â€œåœ£åœ°â€ã€‚åˆ›å»ºå®Œæˆåï¼Œä½ çš„é¡¹ç›®ç»“æ„çœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

![](/QQ20250709-210731.png)

## 2. å¦‚ä½•ä½¿ç”¨å…±äº«ä»£ç 

ç°åœ¨ï¼Œä½ å¯ä»¥åœ¨ `shares` ç›®å½•ä¸­åˆ›å»ºä»»ä½•ä½ æƒ³è¦å…±äº«çš„ `.ts` æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `shares/config.ts` æ–‡ä»¶æ¥å­˜æ”¾æ¸¸æˆçš„æ ¸å¿ƒé…ç½®ï¼š

## `shares/` æ–‡ä»¶å¤¹ï¼šä½ çš„â€œå”¯ä¸€çœŸç›¸æ¥æºâ€

`shares/` æ–‡ä»¶å¤¹é‡Œçš„ä»£ç éå¸¸ç‰¹æ®Šï¼šå®ƒæ—¢å¯ä»¥è¢« `server/` ç›®å½•ä¸‹çš„æœåŠ¡ç«¯ä»£ç å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥è¢« `client/` ç›®å½•ä¸‹çš„å®¢æˆ·ç«¯ä»£ç å¼•ç”¨ã€‚

è¿™è®©å®ƒæˆä¸ºäº†å®šä¹‰ **â€œå”¯ä¸€çœŸç›¸æ¥æº (Single Source of Truth)â€** çš„å®Œç¾åœºæ‰€ã€‚å¯¹äºæ¸¸æˆè§„åˆ™ã€æ•°æ®ç»“æ„ã€è®¡ç®—å…¬å¼ç­‰æ ¸å¿ƒé€»è¾‘ï¼Œä½ åªéœ€è¦åœ¨è¿™é‡Œå†™ä¸€æ¬¡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±èƒ½å…±äº«è¿™å¥—æ ‡å‡†ã€‚

## å®æˆ˜æ¼”ç»ƒï¼šå…±äº«ä¸€ä¸ªç»éªŒå€¼è®¡ç®—å‡½æ•°

è®©æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªå…±äº«çš„å‡½æ•°ï¼Œç”¨äºæ ¹æ®ç­‰çº§è®¡ç®—å‡åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„ç»éªŒå€¼ã€‚

### ç¬¬ 1 æ­¥ï¼šåœ¨ `shares/` ä¸­åˆ›å»ºæ–‡ä»¶å¹¶ç¼–å†™é€»è¾‘

1.  åœ¨ `shares/` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œä¾‹å¦‚ `gameplay.ts`ã€‚
2.  åœ¨ `gameplay.ts` ä¸­ï¼Œç¼–å†™æˆ‘ä»¬çš„ç­‰çº§è®¡ç®—å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ `export` å…³é”®å­—å°†å…¶å¯¼å‡ºã€‚

```ts
// shares/gameplay.ts

/**
 * æ ¹æ®ç©å®¶å½“å‰ç­‰çº§ï¼Œè®¡ç®—å‡åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„æ€»ç»éªŒå€¼
 * @param level å½“å‰ç­‰çº§
 * @returns å‡åˆ°ä¸‹ä¸€çº§æ‰€éœ€çš„ç»éªŒå€¼
 */
export function getXPForLevel(level: number): number {
  // ç­‰çº§è¶Šé«˜ï¼Œæ‰€éœ€ç»éªŒè¶Šå¤š (ä¾‹å¦‚ï¼Œæ¯çº§å¢åŠ 15%)
  return Math.floor(100 * Math.pow(1.15, level - 1));
}
```

### ç¬¬ 2 æ­¥ï¼šåœ¨æœåŠ¡ç«¯ä½¿ç”¨å…±äº«å‡½æ•°

ç°åœ¨ï¼ŒæœåŠ¡ç«¯å¯ä»¥åœ¨å¤„ç†ç©å®¶è·å¾—ç»éªŒçš„é€»è¾‘æ—¶ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦å‡çº§ã€‚

```ts
// server/src/App.ts
import { getXPForLevel } from '../../shares/gameplay';

// ...
  async onPlayerGetKill(player) {
    const currentXP = player.getData('xp');
    const currentLevel = player.getData('level');

    const newXP = currentXP + 50; // æ¯æ¬¡å‡»æ€è·å¾— 50 ç‚¹ç»éªŒ
    player.setData('xp', newXP);

    const xpForNextLevel = getXPForLevel(currentLevel);

    if (newXP >= xpForNextLevel) {
      player.setData('level', currentLevel + 1);
      player.setData('xp', 0); // é‡ç½®ç»éªŒå€¼
      player.sendChat(`æ­å–œï¼ä½ å·²å‡åˆ° ${currentLevel + 1} çº§ï¼`);
    }
  }
// ...
```

### ç¬¬ 3 æ­¥ï¼šåœ¨å®¢æˆ·ç«¯ä½¿ç”¨åŒä¸€ä¸ªå‡½æ•°

åŒæ—¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨ UI ç•Œé¢ä¸Šè°ƒç”¨**å®Œå…¨ç›¸åŒ**çš„å‡½æ•°ï¼Œæ¥æ˜¾ç¤ºå‡çº§è¿›åº¦æ¡ã€‚

```ts
// client/src/App.ts
import { getXPForLevel } from "../../shares/gameplay";

function updateUserXPBar(currentXP: number, currentLevel: number) {
  const xpForNextLevel = getXPForLevel(currentLevel);
  const progress = (currentXP / xpForNextLevel) * 100;

  // å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´æ–°UIçš„å‡½æ•°
  // updateProgressBar('xp-bar', progress, `${currentXP} / ${xpForNextLevel}`);
  console.log(`å½“å‰å‡çº§è¿›åº¦: ${progress.toFixed(1)}%`);
}

// ç›‘å¬æœåŠ¡ç«¯æ•°æ®å˜åŒ–
box.watchData("xp", (newXP) => {
  const currentLevel = box.getData("level");
  updateUserXPBar(newXP, currentLevel);
});
```

ç°åœ¨ï¼Œå¦‚æœå°†æ¥ä½ æƒ³è°ƒæ•´ç»éªŒå€¼æ›²çº¿ï¼Œ**åªéœ€è¦ä¿®æ”¹ `shares/gameplay.ts` ä¸­é‚£ä¸€ä¸ªå‡½æ•°**ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¡¨ç°å°±ä¼šè‡ªåŠ¨ä¿æŒä¸€è‡´ï¼

## ä»€ä¹ˆåº”è¯¥æ”¾è¿› `shares/`ï¼Ÿ

âœ… **é€‚åˆå…±äº«çš„ï¼š**

- **æ¸¸æˆå…¬å¼**ï¼šä¼¤å®³è®¡ç®—ã€ç»éªŒå€¼æ›²çº¿ã€æ‰è½ç‡ç­‰ã€‚
- **æ•°æ®ç»“æ„å®šä¹‰**ï¼šèƒŒåŒ…ç‰©å“ã€ç©å®¶å±æ€§ã€æŠ€èƒ½æ•°æ®ç­‰ TypeScript `interface` æˆ– `type`ã€‚
- **å¸¸é‡**ï¼šä¾‹å¦‚ `const MAX_PLAYERS = 16;`ã€‚
- **çº¯å·¥å…·å‡½æ•°**ï¼šä¸ä¾èµ–ä»»ä½•ç«¯ç¯å¢ƒçš„é€šç”¨å‡½æ•°ï¼ˆå¦‚æ•°å­¦è®¡ç®—ã€å­—ç¬¦ä¸²å¤„ç†ï¼‰ã€‚

ğŸš« **ä¸é€‚åˆå…±äº«çš„ï¼š**

- ä»»ä½•è°ƒç”¨äº†**ä»…é™æœåŠ¡ç«¯ API**çš„ä»£ç  (ä¾‹å¦‚ `player.kick()`ã€`world.createEntity()`)ã€‚
- ä»»ä½•è°ƒç”¨äº†**ä»…é™å®¢æˆ·ç«¯ API**çš„ä»£ç  (ä¾‹å¦‚ `ui.findChildByName()`ã€æ“ä½œ UI å…ƒç´ )ã€‚
- åŒ…å«å¯†é’¥ã€æ•°æ®åº“åœ°å€ç­‰æ•æ„Ÿä¿¡æ¯çš„ä»£ç ã€‚

é€šè¿‡éµå¾ªè¿™ç§â€œå•ä¸€æ•°æ®æºâ€çš„åŸåˆ™ï¼Œä½ å¯ä»¥ç¼–å†™å‡ºæ›´ç®€æ´ã€æ›´å¥å£®ã€æ›´æ˜“äºç»´æŠ¤çš„ä»£ç ã€‚

---

> **ä¸Šä¸€ç¯‡ï¼š[è¿”å›ä¸Šä¸€ç« ï¼šå¼€å‘å·¥ä½œæµ](../04-development-workflow/index.md)**
>
> **ä¸‹ä¸€ç¯‡ï¼š[å…±äº«æ•°æ®ç»“æ„ (Type-Safe Events)](./communicationAgreement.md)**
